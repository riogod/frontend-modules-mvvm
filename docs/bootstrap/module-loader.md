# ModuleLoader

ModuleLoader — сервис загрузки и управления модулями приложения. Координирует весь процесс: от регистрации модулей до их инициализации.

## Два режима работы

ModuleLoader работает по-разному в dev и prod режимах:

```
┌─────────────────────────────────────────────────────────────────┐
│                        DEV режим                                │
│                                                                 │
│  ModuleLoader сам обрабатывает:                                 │
│  • Проверку feature flags и permissions                         │
│  • Разрешение зависимостей между модулями                       │
│  • Обнаружение циклических зависимостей                         │
│  • Построение уровней загрузки                                  │
│                                                                 │
│  Модули берутся из локальных файлов + манифеста                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        PROD режим                               │
│                                                                 │
│  Сервер манифестов уже сделал:                                  │
│  • Предварительную фильтрацию по feature flags и permissions    │
│  • Сортировку по зависимостям                                   │
│  • Проверку доступности модулей                                 │
│                                                                 │
│  ModuleLoader дополнительно:                                    │
│  • Проверяет feature flags и permissions (двойная защита)       │
│  • Проверяет статусы зависимостей (не FAILED)                   │
│  • Загружает модули в порядке от сервера                        │
└─────────────────────────────────────────────────────────────────┘
```

**Почему так?**

- В dev режиме нет реального сервера — нужна полная локальная обработка
- В prod режиме сервер предварительно фильтрует модули, клиент делает финальную проверку
- Тяжелый код (граф зависимостей, уровни) не включается в prod-бандл

## Типы модулей

| Тип        | Когда загружается | Условия загрузки                        |
| ---------- | ----------------- | --------------------------------------- |
| **INIT**   | До рендера UI     | Нет (загружаются всегда)                |
| **NORMAL** | После рендера UI  | Feature flags, permissions, зависимости |

```
Старт приложения
        │
        ▼
┌───────────────┐
│ INIT модули   │ ← Загружаются синхронно, блокируют UI
│ (core, layout)│
└───────┬───────┘
        │
        ▼
   React render
        │
        ▼
┌───────────────┐
│ NORMAL модули │ ← Загружаются асинхронно, не блокируют UI
│ (todo, api)   │
└───────────────┘
```

## Жизненный цикл модуля

```
pending → loading → preloaded → loaded
                        │
                        └──→ failed
```

| Статус      | Описание                                              |
| ----------- | ----------------------------------------------------- |
| `pending`   | Модуль зарегистрирован, но не загружен                |
| `loading`   | Идет загрузка модуля                                  |
| `preloaded` | Маршруты зарегистрированы, полная инициализация позже |
| `loaded`    | Модуль полностью загружен и инициализирован           |
| `failed`    | Ошибка при загрузке                                   |

## Основные методы

### Инициализация

```typescript
const moduleLoader = new BootstrapModuleLoader();

// Связь с Bootstrap
moduleLoader.init(bootstrap);

// Добавление модулей
await moduleLoader.addModules(allModules);
```

### Загрузка модулей

```typescript
// Загрузка INIT модулей (до рендера)
await moduleLoader.initInitModules();

// Предзагрузка маршрутов всех модулей
await moduleLoader.preloadRoutes();

// Загрузка NORMAL модулей (после рендера)
await moduleLoader.loadNormalModules();

// Загрузка конкретного модуля по имени
await moduleLoader.loadModuleByName('my-module');

// Автозагрузка при переходе на маршрут
await moduleLoader.autoLoadModuleByRoute('todo.list');
```

### Получение информации

```typescript
// Получить модуль по имени
const module = moduleLoader.getModule('todo');

// Проверить статус
const isLoaded = moduleLoader.isModuleLoaded('todo');
const isPreloaded = moduleLoader.isModulePreloaded('todo');
const status = moduleLoader.getModuleStatus('todo');

// Все модули
const modules = moduleLoader.getModules();

// Модули определенного типа
const initModules = moduleLoader.getModulesByType(ModuleLoadType.INIT);
```

## Процесс загрузки

### INIT модули

1. ModuleLoader получает список INIT модулей
2. Сортирует по `loadPriority` (меньше = раньше)
3. Загружает **последовательно** — каждый следующий ждет предыдущий
4. Для каждого модуля:
   - Вызывает `onModuleInit(bootstrap)`
   - Регистрирует маршруты в роутере
   - Регистрирует переводы в i18n

```
INIT модуль: core (priority: 0)
        │
        ▼
INIT модуль: core.layout (priority: 2)
        │
        ▼
... другие INIT модули
```

### NORMAL модули

1. ModuleLoader получает список NORMAL модулей
2. **В DEV режиме:**
   - Проверяет feature flags и permissions
   - Строит уровни по зависимостям
   - Загружает уровень за уровнем (модули одного уровня — параллельно)
3. **В PROD режиме:**
   - Модули уже отсортированы сервером
   - Проверяет feature flags и permissions (двойная защита)
   - Проверяет статусы зависимостей (не FAILED)
   - Загружает в порядке от сервера

```
Уровень 0: [модули без зависимостей]     ← параллельно
        │
        ▼
Уровень 1: [модули, зависящие от уровня 0] ← параллельно
        │
        ▼
Уровень 2: [модули, зависящие от уровня 1] ← параллельно
```

## Условия загрузки

ModuleLoader проверяет условия загрузки для NORMAL модулей:

```typescript
const module: NormalModule = {
  name: 'admin-panel',
  loadType: ModuleLoadType.NORMAL,
  config: AdminConfig,
  loadCondition: {
    // Требуемые feature flags
    featureFlags: ['admin.enabled'],

    // Требуемые разрешения
    accessPermissions: ['admin.access'],

    // Зависимости от других модулей
    dependencies: ['core', 'auth'],
  },
};
```

Модуль загрузится только если:

- Все `featureFlags` включены
- Все `accessPermissions` есть у пользователя
- Все `dependencies` уже загружены

**Различия по режимам:**

| Условие       | DEV                     | PROD                                          |
| ------------- | ----------------------- | --------------------------------------------- |
| Feature flags | Проверяются на клиенте  | Проверяются на клиенте + сервер предфильтрует |
| Permissions   | Проверяются на клиенте  | Проверяются на клиенте + сервер предфильтрует |
| Dependencies  | Полное разрешение графа | Только проверка статусов                      |

> В PROD режиме сервер предварительно фильтрует модули, но клиент делает финальную проверку feature flags и permissions. Это двойная защита.

## Предзагрузка маршрутов

`preloadRoutes()` регистрирует роуты всех модулей из их конфигов до старта роутера:

```typescript
// В bootstrap, перед router.start()
await moduleLoader.preloadRoutes();
```

**Что происходит:**

1. **INIT модули** — маршруты регистрируются синхронно (они уже загружены)
2. **NORMAL модули** — только маршруты регистрируются синхронно, полная загрузка (`onModuleInit`, i18n) происходит асинхронно после рендера

Это оптимизирует время первого рендера — пользователь видит UI быстрее.

## Автозагрузка по маршруту

Когда пользователь переходит на маршрут незагруженного модуля:

```typescript
// Роутер вызывает при переходе
await moduleLoader.autoLoadModuleByRoute('todo.list');
```

ModuleLoader:

1. Находит модуль по имени маршрута
2. Проверяет, не загружен ли уже
3. Проверяет условия загрузки (feature flags, permissions)
4. Загружает зависимости (полный граф в DEV, проверка статусов в PROD)
5. Загружает модуль
6. Возвращает управление роутеру

## Обработка ошибок

Ошибка в одном модуле не блокирует загрузку остальных:

```typescript
// ModuleLoader логирует ошибку и продолжает
await moduleLoader.loadNormalModules();
// Модули с ошибками помечаются как 'failed'
// Остальные модули загружаются нормально
```

Проверка статуса после загрузки:

```typescript
const status = moduleLoader.getModuleStatus('problematic-module');
if (status === ModuleLoadStatus.FAILED) {
  // Обработка ошибки
}
```

## Архитектура ModuleLoader

```
┌─────────────────────────────────────────────────────────────┐
│                      ModuleLoader                           │
│                        (Facade)                             │
└─────────────────────────────┬───────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ ModuleRegistry│    │ StatusTracker │    │LifecycleManager│
│               │    │               │    │               │
│ • Хранение    │    │ • Статусы     │    │ • onModuleInit│
│ • Поиск       │    │ • События     │    │ • routes      │
│ • Сортировка  │    │               │    │ • i18n        │
└───────────────┘    └───────────────┘    └───────────────┘
                              │
        ┌─────────────────────┴─────────────────────┐
        │                                           │
        ▼                                           ▼
┌───────────────────────┐              ┌───────────────────────┐
│   InitLoadStrategy    │              │  NormalLoadStrategy   │
│                       │              │                       │
│ • Последовательная    │              │ • Параллельная        │
│   загрузка            │              │   загрузка по уровням │
└───────────────────────┘              └───────────────────────┘
```

### Компоненты

| Компонент              | Назначение                                                       |
| ---------------------- | ---------------------------------------------------------------- |
| **ModuleRegistry**     | Хранит модули, поиск по имени/маршруту, сортировка по приоритету |
| **StatusTracker**      | Отслеживает статус каждого модуля (pending, loading, loaded...)  |
| **LifecycleManager**   | Вызывает хуки модуля: `onModuleInit`, регистрация routes и i18n  |
| **InitLoadStrategy**   | Стратегия для INIT модулей — последовательная загрузка           |
| **NormalLoadStrategy** | Стратегия для NORMAL модулей — параллельная загрузка по уровням  |

### DEV-only компоненты

Эти компоненты загружаются только в dev режиме (не попадают в prod-бандл):

| Компонент                  | Назначение                                   |
| -------------------------- | -------------------------------------------- |
| **ConditionValidator**     | Проверка feature flags, permissions          |
| **DependencyResolver**     | Разрешение зависимостей, обнаружение циклов  |
| **DependencyLevelBuilder** | Построение уровней для параллельной загрузки |

## Remote модули

ModuleLoader поддерживает загрузку remote модулей через Module Federation:

```typescript
// Загрузка remote модуля
const config = await loadRemoteModule(
  'remote-module',
  'https://cdn.example.com/remoteEntry.js',
  { timeout: 5000, retries: 3 },
);
```

Remote модули:

- Загружаются по URL из манифеста
- Используют shared scope для общих зависимостей
- Кешируются после первой загрузки
